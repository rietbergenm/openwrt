#include "grx390.dtsi"
#include <dt-bindings/mips/lantiq_rcu_gphy.h>
#include <dt-bindings/input/input.h>
#include <dt-bindings/gpio/gpio.h>

/ {
	compatible = "draytek,vigor2862", "lantiq,xway", "lantiq,grx390";
	model = "Draytek Vigor2862";

	chosen {
		bootargs = "console=ttyLTQ0,115200";
	};

	memory@0 {
		device_type = "memory";
		reg = <0x00 0xff00000>;
	};

	usb0_vbus: regulator-usb0-vbus {
		compatible = "regulator-fixed";

		regulator-name = "USB0_VBUS";

		regulator-min-microvolt = <5000000>;
		regulator-max-microvolt = <5000000>;

		gpios = <&stp 4 GPIO_ACTIVE_HIGH>;
		enable-active-high;
	};

	usb1_vbus: regulator-usb1-vbus {
		compatible = "regulator-fixed";
		regulator-name = "USB1_VBUS";

		regulator-min-microvolt = <5000000>;
		regulator-max-microvolt = <5000000>;

		gpios = <&stp 7 GPIO_ACTIVE_HIGH>;
		enable-active-high;
	};
};

&gphy0 {
	lantiq,gphy-mode = <GPHY_MODE_GE>;
};

&gphy1 {
	lantiq,gphy-mode = <GPHY_MODE_GE>;
};

&gphy2 {
	lantiq,gphy-mode = <GPHY_MODE_GE>;
};

&gphy3 {
	lantiq,gphy-mode = <GPHY_MODE_GE>;
};


&gswip {
	pinctrl-0 = <&mdio_pins>;
	pinctrl-names = "default";
};


&gswip_mdio {
	phy1: ethernet-phy@1 {
		reg = <0x01>;
	};

	phy2: ethernet-phy@2 {
		reg = <0x02>;
	};

	phy3: ethernet-phy@3 {
		reg = <0x03>;
	};

	phy4: ethernet-phy@4 {
		reg = <0x04>;
	};
};

/*
 * port 1 2 3 4 6 are internal;
 * 0 can do all types of rgmii in addition to rmii and gmii;
 * 5 can do all types of rgmii in addition to rmii and internal;
 */
&gswip_ports {
	port@1 {
		reg = <1>;
		label = "port1";
		phy-mode = "internal";
		phy-handle = <&phy3>;
	};

	port@2 {
		reg = <2>;
		label = "port2";
		phy-mode = "internal";
		phy-handle = <&phy1>;
	};

	port@3 {
		reg = <3>;
		label = "port3";
		phy-mode = "internal";
		phy-handle = <&phy4>;
	};

	port@4 {
		reg = <4>;
		label = "port4";
		phy-mode = "internal";
		phy-handle = <&phy2>;
	};
};

&localbus {
	// not fully working yet, partitions don't show up
	nand@1 {
		compatible = "lantiq,nand-xway";
		lantiq,cs = <1>;
		bank-width = <2>;
		reg = <1 0x0 0x2000000>;
		#address-cells = <1>;
		#size-cells = <1>;

		pinctrl-0 = <&nand_pins>, <&nand_cs1_pins>;
		pinctrl-names = "default";

		nand-on-flash-bbt;

		// ecc?

		partitions {
			compatible = "fixed_partitions";
			#address-cells = <1>;
			#size-cells = <1>;

			partition@0 {
				label = "uboot";
				reg = <0x00 0x100000>;
				read-only;
			};

			partition@100000 {
				label = "ubootconfigA";
				reg = <0x100000 0x40000>;
				read-only;
			};

			partition@140000 {
				label = "ubootconfigB";
				reg = <0x140000 0x40000>;
				read-only;
			};

			partition@180000 {
				label = "gphyfirmware";
				reg = <0x180000 0x40000>;
				read-only;
			};

			partition@1c0000 {
				label = "system_sw";
				reg = <0x1c0000 0x3200000>;
				read-only;
			};

			partition@33c0000 {
				label = "calibration";
				reg = <0x33c0000 0x100000>;
				read-only;
			};

			partition@34c0000 {
				label = "res";
				reg = <0x34c0000 0xb40000>;
				read-only;
			};
		};
	};
};


&spi {
	status = "okay";

	m25p80@1 { 
		#address-cells = <1>;
		#size-cells = <1>;
		compatible = "jedec,spi-nor";
		reg = <1>;
		spi-max-frequency = <1000000>; // 1 MHz

		partitions {
			compatible = "fixed-partitions";
			#address-cells = <1>;
			#size-cells = <1>;

			partition@0 {
				reg = <0x00 0x31000>;
				label = "DrayBoot (u-boot)";
				read-only;
			};

			partition@31000 {
				reg = <0x31000 0xf000>;
				label = "res (unknown)";
				read-only;
			};
		};
	};
};

&usb_phy0 {
	status = "okay";
};

&usb_phy1 {
	status = "okay";
};

&usb0 {
	status = "okay";
	vbus-supply = <&usb0_vbus>;
};

&usb1 {
	status = "okay";
	vbus-supply = <&usb1_vbus>;
};
