/include/ "grx390.dtsi"


/ {
	compatible = "draytek,vigor2862", "lantiq,xway", "lantiq,grx390";
	model = "Draytek Vigor2862";

	chosen {
		bootargs = "console=ttyLTQ0,115200";
	};

	memory@0 {
		device_type = "memory";
		reg = <0x00 0xff00000>;
	};

	usb0_vbus: regulator-usb0-vbus {
		compatible = "regulator-fixed";

		regulator-name = "USB0_VBUS";

		regulator-min-microvolt = <5000000>;
		regulator-max-microvolt = <5000000>;

		gpios = <&stp 4 0>; // active high (#include later)
		enable-active-high;
	};

	usb1_vbus: regulator-usb1-vbus {
		compatible = "regulator-fixed";
		regulator-name = "USB1_VBUS";

		regulator-min-microvolt = <5000000>;
		regulator-max-microvolt = <5000000>;

		gpios = <&stp 7 0>; // active high replace with #include later
		enable-active-high;
	};
};

&localbus {
	// not fully working yet, partitions don't show up
	nand@1 {
		compatible = "lantiq,nand-xway";
		lantiq,cs = <1>;
		bank-width = <2>;
		reg = <1 0x0 0x2000000>;
		#address-cells = <1>;
		#size-cells = <1>;

		nand-on-flash-bbt; // gets detected properly by the kernel!

		// ecc?

		partitions {
			compatible = "fixed_partitions";
			#address-cells = <1>;
			#size-cells = <1>;

			partition@0 {
				label = "uboot";
				reg = <0x00 0x100000>;
				read-only;
			};

			partition@100000 {
				label = "ubootconfigA";
				reg = <0x100000 0x40000>;
				read-only;
			};

			partition@140000 {
				label = "ubootconfigB";
				reg = <0x140000 0x40000>;
				read-only;
			};

			partition@180000 {
				label = "gphyfirmware";
				reg = <0x180000 0x40000>;
				read-only;
			};

			partition@1c0000 {
				label = "system_sw";
				reg = <0x1c0000 0x3200000>;
				read-only;
			};

			partition@33c0000 {
				label = "calibration";
				reg = <0x33c0000 0x100000>;
				read-only;
			};

			partition@34c0000 {
				label = "res";
				reg = <0x34c0000 0xb40000>;
				read-only;
			};
		};
	};
};


&spi {
	status = "okay";

	m25p80@1 { 
		#address-cells = <1>;
		#size-cells = <1>;
		compatible = "jedec,spi-nor";
		reg = <1>;
		spi-max-frequency = <0xf4240>;

		partitions {
			compatible = "fixed-partitions";
			#address-cells = <1>;
			#size-cells = <1>;

			partition@0 {
				reg = <0x00 0x20000>;
				label = "SPI (RO) U-Boot Image";
				read-only;
			};

			partition@20000 {
				reg = <0x20000 0x10000>;
				label = "ENV_MAC";
				read-only;
			};

			partition@30000 {
				reg = <0x30000 0x10000>;
				label = "DPF";
				read-only;
			};

			/* last two partitions are out of reach??
			 * makes sense, as 0x40000 is 256KB, the size of our
			 * spi chip. So this is a questionable partition map...
			 * also, why would there be a kernel on the spi chip
			 * shouldn't this just hold the bootloader and fw?
			 */
			partition@40000 {
				reg = <0x40000 0x10000>;
				label = "NVRAM";
				read-only;
			};

			partition@500000 {
				reg = <0x50000 0x3a0000>;
				label = "kernel";
				read-only;
			};
		};
	};
};

&usb_phy0 {
	status = "okay";
};

&usb_phy1 {
	status = "okay";
};

&usb0 {
	status = "okay";
	vbus-supply = <&usb0_vbus>;
};

&usb1 {
	status = "okay";
	vbus-supply = <&usb1_vbus>;
};
